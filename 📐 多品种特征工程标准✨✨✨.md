# 📐 多品种特征工程标准

> **目标**：让任何品种（数字货币、股票、ETF）的数据，都能通过统一流水线，生成 **标准化 NPZ 文件**，无缝对接 RL 训练。
>
> 📌 **核心原则**：一套命名规范 → 一条流水线 → 一份契约文件 → 无缝训练

---

## 🎯 一、架构总览

### 1.1 数据流水线（5步走）

```text
📥 Step1  原始数据获取    →  {品种标识}_{周期}.csv
📊 Step2  时间重采样      →  {品种标识}_{周期}.parquet
📈 Step3  指标计算        →  {品种标识}_{周期}_indicators.parquet
🔗 Step4  多周期融合      →  {品种标识}_{基础周期}_merged.parquet
🤖 Step5  RL特征导出      →  {品种标识}_{基础周期}_rl_features.npz   ← RL训练唯一入口
```

### 1.2 核心契约

| 层级 | 文件 | 作用 |
|------|------|------|
| **配置层** | `congfigs/main_config.yaml` | 品种、周期、路径统一配置 |
| **数据层** | `*_merged.parquet` | 原始特征真相源（未归一化） |
| **训练层** | `*_rl_features.npz` | RL 模型唯一输入（已归一化） |
| **契约层** | `schema_sha` 哈希值 | 特征列表校验（离线/在线一致性） |

---

## 📛 二、多品种命名规范

### 2.1 品种标识符（Symbol ID）

**格式**：`{资产代码}_{计价货币}` （全大写、下划线分隔）

| 品种类型 | 示例 | 说明 |
|----------|------|------|
| 数字货币 | `BTC_USDT`、`ETH_USDT` | 交易对，计价货币为稳定币 |
| 美股 | `AAPL_USD`、`TSLA_USD` | 股票代码 + 美元 |
| A股 | `600519_CNY`、`000001_CNY` | 股票代码 + 人民币 |
| ETF | `SPY_USD`、`QQQ_USD` | ETF代码 + 计价货币 |
| 期货 | `CL_USD`（原油）、`GC_USD`（黄金） | 期货代码 + 美元 |

### 2.2 文件命名模板

```yaml
# Step1-5 统一命名（{symbol} = 品种标识符，{tf} = 时间周期）
download:   "{symbol}_{market_type}_{tf}.csv"     # BTC_USDT_SWAP_1m.csv
kline:      "{symbol}_{tf}.parquet"               # BTC_USDT_3m.parquet
indicator:  "{symbol}_{tf}_indicators.parquet"    # BTC_USDT_3m_indicators.parquet
merged:     "{symbol}_{tf}_merged.parquet"        # BTC_USDT_3m_merged.parquet
rl_features:"{symbol}_{tf}_rl_features.npz"       # BTC_USDT_3m_rl_features.npz
```

### 2.3 配置文件示例

```yaml
# congfigs/main_config.yaml
symbol:
  trading_pair_std: "AAPL_USD"      # ← 改这里即可切换品种
  trading_pair_exchange: "AAPL"     # 交易所API使用的格式
  market_type: "stock"              # stock | etf | crypto_spot | crypto_swap
```

---

## 📊 三、特征标准（RL 契约）

### 3.1 核心特征分组（必须包含）

| 分组 | 代表列 | 维度 | 取值范围 | 说明 |
|------|--------|------|----------|------|
| 🎯 **market_state** | `{tf}_market_state` | 4 | `{-1, 1}` | 趋势方向（必须） |
| 📈 **momentum** | `{tf}_mom` | 4 | `[-1, 1]` | 动量指标（必须） |
| 📊 **band_width** | `{tf}_bb_width` | 4 | `[0, 1]` | 波动宽度（推荐） |
| 📢 **volume** | `{tf}_volume` | 4 | `[0, 1]` | 成交量分位（推荐） |
| 💥 **atr_pct** | `{tf}_atr_pct` | 4 | `[0, ∞)` | ATR百分比（推荐） |
| 🌊 **rv** | `{tf}_rv` | 4 | `[0, 0.1]` | 已实现波动率（可选） |
| 🎚️ **rsi_continuous** | `{tf}_rsi*` | 12 | `[-1, 1]` | RSI系列（可选） |
| ⏰ **time_encoding** | `time_*_sin/cos` | 4 | `[-1, 1]` | 时间编码（推荐） |
| 💰 **price** | `{base_tf}_open/high/low/close` | 4 | 原始价格 | OHLC（必须） |
| 📉 **return** | `ret_{base_tf}_log` | 1 | `[-1, 1]` | 对数收益率（推荐） |

> **{tf}** = 时间周期，如 `3m`、`15m`、`30m`、`2h`
> **{base_tf}** = 基础周期（Step5 输出使用的周期）

### 3.2 多周期配置（4层时间尺度）

```yaml
timeframes:
  base_download: "1m"                        # 原始数据周期
  resample_targets: ["3m", "15m", "30m", "2h"]  # 重采样目标
```

**周期语义**：
```text
3m   (基础周期) ━━━━━► 高频信号、短线交易
15m  (短期趋势) ━━━━━► 短线波段、日内趋势
30m  (中期趋势) ━━━━━► 中期方向、持仓判断
2h   (长期趋势) ━━━━━► 宏观方向、仓位管理
```

### 3.3 NPZ 文件结构（RL 接口契约）

```python
# 🔥 这是 RL 模型的唯一数据输入格式
{
    'version': '1.0',                    # 版本号
    'observations': (N, D),              # 特征矩阵 (样本数, 特征维度)
    'feature_names': [...],              # 特征名称列表 (D个)
    'feature_groups': [...],             # 特征分组标签 (D个)
    'timestamps': (N,),                  # Unix时间戳（毫秒）
    'prices': (N, 4),                    # OHLC价格矩阵
    'schema_sha': '...',                 # 🔥 特征列表哈希（一致性校验）
    'metadata': {
        'symbol': 'BTC_USDT',            # 品种标识
        'base_timeframe': '3m',          # 基础周期
        'created_at': '2025-12-10',      # 生成时间
        ...
    }
}
```

### 3.4 数据质量门禁

| 检查项 | 阈值 | 说明 |
|--------|------|------|
| NaN 比例 | < 1e-6 | 特征不能有缺失值 |
| 零方差比例 | < 0.01 | 至少 99% 特征有变化 |
| 离群值比例 | < 2% | 极端值占比控制 |
| 时间戳连续 | 100% | 不允许时间跳跃 |

---

## 🔌 四、RL 端接口

### 4.1 数据加载（RL 侧）

```python
# rl_long/data_processor/data_processor.py
class DataProcessor:
    """RL 数据处理器：加载 NPZ，分割数据，输出标准格式"""
    
    def process(self) -> Dict[str, Any]:
        # 加载 observations, timestamps, prices
        features, labels, timestamps, feature_names, price_data = self._load_raw_data()
        
        # 时间序列分割（训练/验证/测试）
        data_splits = self._split_data_with_timestamps_and_prices(...)
        
        return result  # 标准格式输出
```

### 4.2 配置对接（RL 侧）

```yaml
# rl_long/configs/cool_config/data_config.yaml
data_source:
  features_file: "/root/FinRL_bn/data/rl_live/data_ready/{symbol}_3m_rl_features.npz"
  features_key: "observations"
  labels_file: "/root/FinRL_bn/data/rl_live/data_ready/{symbol}_3m_rl_labels.npz"
  labels_key: "states"
```

### 4.3 特征矩阵开关（RL 侧策略适配）

```yaml
# 不同策略使用不同特征组合
feature_selection:
  matrix:
    # 趋势策略：使用市场状态 + 动量
    trend:
      3m: [market_state, momentum]
      15m: [market_state, momentum]
      30m: [market_state, momentum, band_width]
      2h: [market_state, momentum, band_width]
    
    # 震荡策略：使用 RSI 信号
    oscillation:
      3m: [rsi_signal]
      15m: [rsi_signal]
      30m: [market_state]
      2h: [market_state]
```

---

## 🚀 五、新品种开发指南（5步快速上手）

### Step 1：配置品种参数

```yaml
# features_engineering/congfigs/main_config.yaml
symbol:
  trading_pair_std: "AAPL_USD"       # 品种标识符
  trading_pair_exchange: "AAPL"      # API 调用格式
  market_type: "stock"               # 市场类型

exchange:
  name: "alpaca"                     # 数据源（alpaca/yfinance/ccxt）
```

### Step 2：实现数据下载器

```python
# features_engineering/step1_data.py
class StockDataDownloader:
    """股票数据下载器（继承或新建）"""
    
    def download(self, symbol: str, start_date: str, end_date: str) -> pd.DataFrame:
        """返回标准 OHLCV 格式"""
        # columns: ['timestamp', 'open', 'high', 'low', 'close', 'volume']
        ...
```

### Step 3：验证指标计算

```bash
# 运行 Step2-3，检查指标是否正常生成
python features_engineering/run2_offline_pipeline.py --sample_ratio 0.01
```

### Step 4：检查 NPZ 输出

```python
import numpy as np

path = "data/rl_live/data_ready/AAPL_USD_3m_rl_features.npz"
with np.load(path, allow_pickle=True) as z:
    print(f"特征维度: {z['observations'].shape}")       # 应为 (N, 45) 或类似
    print(f"特征列表: {z['feature_names'].tolist()}")   # 检查是否包含必须特征
    print(f"时间范围: {z['timestamps'][0]} ~ {z['timestamps'][-1]}")
```

### Step 5：对接 RL 训练

```yaml
# rl_long/configs/cool_config/data_config.yaml
data_source:
  features_file: "/root/FinRL_bn/data/rl_live/data_ready/AAPL_USD_3m_rl_features.npz"
  ...
```

```bash
# 运行测试训练
python rl_long/test_train.py
```

---

## 🔧 六、不同品种的特殊处理

### 6.1 数字货币 vs 股票/ETF

| 特性 | 数字货币 | 股票/ETF |
|------|----------|----------|
| 交易时间 | 7×24 小时 | 交易时段（如 9:30-16:00） |
| 时间编码 | `hour_sin/cos`（24h周期） | 需添加 `session_sin/cos`（盘前/盘中/盘后） |
| 成交量 | 连续、无间断 | 盘前盘后成交量低 |
| 基础周期 | 1m / 3m | 1m / 5m（取决于数据源） |
| 市场类型 | `crypto_spot` / `crypto_swap` | `stock` / `etf` |

### 6.2 时间编码适配

```python
# 股票需要额外处理交易时段
def add_trading_session_encoding(df: pd.DataFrame) -> pd.DataFrame:
    """添加交易时段编码（盘前/盘中/盘后）"""
    hour = df['timestamp'].dt.hour
    minute = df['timestamp'].dt.minute
    
    # 美股示例：9:30-16:00 为盘中
    is_market_open = (hour >= 9.5) & (hour < 16)
    df['session_is_open'] = is_market_open.astype(float)
    
    return df
```

### 6.3 缺失值处理

| 场景 | 数字货币 | 股票 |
|------|----------|------|
| 周末 | 正常交易 | 无数据 → 跳过或填充 |
| 节假日 | 正常交易 | 无数据 → 跳过或填充 |
| 盘后 | N/A | 低成交 → 可用 `ffill` 填充 |

```yaml
# 股票特殊配置
timeframes:
  fill_kline_outputs: true           # 补齐缺失网格
  indicators_fill_method: "ffill"    # 前向填充
```

---

## 📋 七、检查清单（上线前必查）

### 7.1 特征工程端

- [ ] 品种标识符符合规范（`{资产代码}_{计价货币}`）
- [ ] 文件命名遵循模板
- [ ] Step1-5 全流程跑通
- [ ] NPZ 包含所有必须字段（observations/feature_names/timestamps/prices/schema_sha）
- [ ] 特征维度一致（训练/验证/测试）
- [ ] 数据质量门禁全部通过

### 7.2 RL 训练端

- [ ] `data_config.yaml` 路径正确
- [ ] 特征矩阵开关与策略匹配
- [ ] 时间分割合理（训练/验证/测试不重叠）
- [ ] `test_train.py` 能正常启动

### 7.3 实盘端（可选）

- [ ] `live_overrides.yaml` 配置品种
- [ ] 预检四阶段通过
- [ ] 特征 MAE < 0.02、Corr > 0.98

---

## 🧠 八、常见问题

### Q1：新品种需要修改哪些文件？

**必改**：
1. `congfigs/main_config.yaml` → 配置品种标识
2. `step1_data.py` → 实现数据下载（如需新数据源）
3. `rl_long/configs/cool_config/data_config.yaml` → 指向新 NPZ

**可选**：
- `base_indicators.yaml` → 调整指标参数（如不同品种波动率差异）
- `step5_mapping.yaml` → 调整特征归一化策略

### Q2：如何验证 NPZ 与 RL 端兼容？

```python
# 快速验证脚本
from rl_long.data_processor import DataProcessor

processor = DataProcessor(training_mode="test")
result = processor.process()

print(f"训练集样本: {result['train']['features'].shape}")
print(f"验证集样本: {result['val']['features'].shape}")
print(f"测试集样本: {result['test']['features'].shape}")
```

### Q3：多品种同时训练怎么办？

当前架构是**单品种单模型**，如需多品种：
1. 为每个品种生成独立 NPZ
2. 分别训练不同模型
3. 实盘通过策略调度器切换

---

## 🔐 九、安全配置（GitHub 分享必读）

### 9.1 敏感信息存放位置

**⚠️ 绝对不要提交到 Git 的内容：**

| 敏感类型 | 正确存放位置 | 说明 |
|----------|--------------|------|
| API 密钥 | **环境变量** | `~/.bashrc` 或 `.env` 文件（已在 `.gitignore`） |
| 交易所密码 | **环境变量** | 同上 |
| 私钥/证书 | **项目外目录** | 如 `~/.secrets/` |
| 训练数据 | **data/** | 已在 `.gitignore` |

### 9.2 环境变量配置示例

```bash
# ~/.bashrc 或 ~/.zshrc（本地配置，不提交 Git）
export OKX_API_KEY="your_api_key_here"
export OKX_API_SECRET="your_api_secret_here"
export OKX_API_PASSPHRASE="your_passphrase_here"

export BINANCE_API_KEY="your_api_key_here"
export BINANCE_API_SECRET="your_api_secret_here"

# 股票数据源（如需）
export ALPACA_API_KEY="your_api_key_here"
export ALPACA_API_SECRET="your_api_secret_here"
```

### 9.3 .gitignore 必须包含

```gitignore
# 敏感配置
.env
.env.*
*.secret
secrets/

# 数据目录
data/
data_trading/

# 本地缓存
__pycache__/
*.pyc
.cache/

# 模型权重（可选）
*.zip
*.pth
*.pt
```

### 9.4 分享前检查清单

- [ ] 运行 `git diff --cached` 确认无敏感信息
- [ ] 检查 YAML 中无硬编码的 API 密钥
- [ ] 确认 `data/` 目录已被 `.gitignore` 忽略
- [ ] 路径使用相对路径或占位符（如 `{io.base_dir}`）

### 9.5 代码设计原则

```python
# ✅ 正确：从环境变量读取
api_key = os.environ.get("OKX_API_KEY", "")

# ❌ 错误：硬编码密钥
api_key = "sk-xxxx-your-real-key"  # 绝对不要这样！
```

---

## 📚 十、相关文档索引

| 文档 | 路径 | 内容 |
|------|------|------|
| 数据流水线总览 | `💹 README_data流水线和标准.md` | Step1-5 详细流程 |
| RL 特征规格 | `📊 README_RL2_Featueres_特征数据.md` | 45维特征详解 |
| RL 训练配置 | `rl_long/configs/Config-简介.md` | 配置体系说明 |
| 实盘预检 | `live_trading/preflight/🎨 预检架构.MD` | 预检四阶段 |

---

> **核心理念**：品种变，标准不变。
> 
> 🎯 所有品种最终都输出同一格式的 NPZ，RL 端无需感知品种差异。

---

*更新时间：2025-12-10*

